<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UbuntuShield - Security Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Top Navigation */
        .navbar {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .navbar-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .brand-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
        }

        .brand-text p {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .navbar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .last-update {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 1.8rem;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .server-count {
            background: #334155;
            color: #e2e8f0;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Server Cards */
        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
        }

        .server-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .server-card:hover {
            border-color: #3b82f6;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .server-card.main-server {
            border: 2px solid #3b82f6;
            background: linear-gradient(135deg, #1e293b 0%, #1e3a5f 100%);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .server-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 5px;
        }

        .server-ip {
            font-size: 0.85rem;
            color: #94a3b8;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-main { background: #3b82f6; color: white; }
        .status-online { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-offline { background: #ef4444; color: white; }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-excellent { color: #10b981; }
        .score-good { color: #3b82f6; }
        .score-warning { color: #f59e0b; }
        .score-danger { color: #ef4444; }

        /* Details */
        .details-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-top: 1px solid #334155;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .detail-value {
            font-size: 0.85rem;
            color: #e2e8f0;
            font-weight: 600;
        }

        /* Empty State */
        .empty-state {
            background: #1e293b;
            border: 2px dashed #334155;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
        }

        .empty-text {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 25px;
        }

        .code-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #3b82f6;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .spinner {
            border: 3px solid #334155;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f8fafc;
        }

        .modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: #f8fafc;
            background: #334155;
            border-radius: 6px;
        }

        .instruction-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instruction-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instruction-text {
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .code-snippet {
            background: #000;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            color: #10b981;
            font-size: 0.9rem;
            position: relative;
            overflow-x: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #334155;
            border: none;
            color: #e2e8f0;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #3b82f6;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Search & Filter Bar */
        .search-filter-bar {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: #1e293b;
        }

        .search-input::placeholder {
            color: #64748b;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .filter-select {
            padding: 10px 15px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-select:hover {
            border-color: #475569;
        }

        .clear-filters-btn {
            padding: 10px 20px;
            background: #334155;
            border: none;
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .clear-filters-btn:hover {
            background: #475569;
        }

        /* Compliance Cards */
        .compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .compliance-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .compliance-card:hover {
            transform: translateY(-3px);
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .compliance-framework {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .compliance-score {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .compliance-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .servers-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .modal {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Add Server Modal -->
    <div class="modal-overlay" id="addServerModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï Add New Server</h2>
                <button class="modal-close" onclick="closeAddServerModal()">‚úï</button>
        </div>

            <div class="instruction-box">
                <div class="instruction-title">
                    <span class="step-number">1</span>
                    <span>Install Lynis on Target Server</span>
            </div>
                <p class="instruction-text">
                    SSH into your remote server and install Lynis security auditing tool.
                </p>
                <div class="code-snippet">
                    <button class="copy-btn" onclick="copyToClipboard('sudo apt update && sudo apt install lynis -y', this)">Copy</button>
                    sudo apt update && sudo apt install lynis -y
            </div>
            </div>

            <div class="instruction-box">
                <div class="instruction-title">
                    <span class="step-number">2</span>
                    <span>Deploy Agent from Central Server</span>
            </div>
                <p class="instruction-text">
                    Run this command from your central server (this machine) to automatically deploy the monitoring agent.
                </p>
                <div class="code-snippet">
                    <button class="copy-btn" onclick="copyToClipboard('./deploy-agent.sh user@server-ip', this)">Copy</button>
                    ./deploy-agent.sh user@server-ip
            </div>
                <p class="instruction-text" style="margin-top: 15px; color: #64748b; font-size: 0.9rem;">
                    Example: <code style="color: #3b82f6;">./deploy-agent.sh root@192.168.1.50</code>
                </p>
            </div>

            <div class="instruction-box">
                <div class="instruction-title">
                    <span class="step-number">3</span>
                    <span>Verify Connection</span>
            </div>
                <p class="instruction-text">
                    The server will automatically appear in your dashboard within 1-2 minutes after successful deployment.
                </p>
                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    <p style="color: #3b82f6; font-size: 0.9rem; margin: 0;">
                        ‚úì The agent will automatically register<br>
                        ‚úì Send heartbeats every 5 minutes<br>
                        ‚úì Run security audits every 6 hours<br>
                        ‚úì Display real-time status in dashboard
                    </p>
            </div>
            </div>

            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 12px; padding: 20px; margin-top: 25px;">
                <div style="font-weight: 600; color: #10b981; margin-bottom: 10px; font-size: 1.1rem;">
                    üìö Need Help?
            </div>
                <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px;">
                    For detailed deployment instructions, troubleshooting, and manual setup:
                </p>
                <div style="color: #3b82f6; font-family: monospace; font-size: 0.9rem;">
                    üìñ See: DEPLOY_AGENT.md
            </div>
    </div>

            <div style="margin-top: 25px; text-align: center;">
                <button class="btn btn-secondary" onclick="closeAddServerModal()" style="padding: 12px 30px;">
                    Close
            </button>
        </div>
            </div>
        </div>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <div class="logo">üõ°Ô∏è</div>
                <div class="brand-text">
                    <h1>UbuntuShield</h1>
                    <p id="lastUpdate">Security Monitoring System</p>
            </div>
            </div>
            <div class="navbar-actions">
                <button class="btn btn-primary" onclick="showAddServerModal()">
                    ‚ûï Add Server
                </button>
                <button class="btn btn-secondary" onclick="refreshDashboard()">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard...</p>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval = null;
        let localSystemData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            startAutoRefresh();
        });

        async function loadDashboard() {
            // Load both local system and remote servers
            const [localData, serversData] = await Promise.all([
                loadLocalSystem(),
                loadRemoteServers()
            ]);

            showDashboard(localData, serversData);
            updateLastUpdate();
        }

        async function loadLocalSystem() {
            try {
                const response = await fetch('/api/analysis');
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error loading local system:', error);
            }
            return null;
        }

        async function loadRemoteServers() {
            try {
                const response = await fetch('/api/servers');
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('Error loading remote servers:', error);
            }
            return null;
        }

        let allServersGlobal = []; // Store for filtering
        let complianceDataGlobal = null;

        function showDashboard(localData, serversData) {
            const content = document.getElementById('dashboardContent');
            
            // Combine local system and remote servers
            allServersGlobal = [];
            
            // Add local system as first server (main server)
            if (localData) {
                allServersGlobal.push({
                    id: 'local',
                    hostname: 'Main Server (Local)',
                    ip_address: 'localhost',
                    status: 'main',
                    is_local: true,
                    metrics: {
                        hardening_index: localData.hardening_index || '0',
                        tests_performed: localData.tests_performed || '0',
                        warnings: localData.warnings || '0',
                        suggestions: localData.suggestions || '0'
                    },
                    os: localData.os_name || 'Unknown',
                    last_scan: localData.scan_date || 'Never',
                    lynis_version: localData.lynis_version || 'N/A'
                });
            }

            // Add remote servers
            if (serversData && serversData.servers) {
                serversData.servers.forEach(server => {
                    allServersGlobal.push({
                        id: server.id,
                        hostname: server.hostname,
                        ip_address: server.ip_address,
                        status: server.status,
                        is_local: false,
                        metrics: server.latest_metrics || {},
                        os: server.os,
                        arch: server.arch,
                        last_heartbeat: server.last_heartbeat
                    });
                });
            }

            // Load compliance data if we have local data
            if (localData) {
                loadComplianceData();
            }

            renderDashboard(allServersGlobal);
        }

        async function loadComplianceData() {
            try {
                const response = await fetch('/compliance');
                if (response.ok) {
                    complianceDataGlobal = await response.json();
                }
            } catch (error) {
                console.error('Error loading compliance data:', error);
            }
        }

        function renderDashboard(servers) {
            const content = document.getElementById('dashboardContent');
            const allServers = servers;

            // Calculate overall stats
            const totalServers = allServers.length;
            let totalScore = 0;
            let totalWarnings = 0;
            let activeCount = 0;

            allServers.forEach(server => {
                const score = parseInt(server.metrics.hardening_index) || 0;
                const warnings = parseInt(server.metrics.warnings) || 0;
                totalScore += score;
                totalWarnings += warnings;
                if (server.status === 'active' || server.status === 'main') activeCount++;
            });

            const avgScore = totalServers > 0 ? Math.round(totalScore / totalServers) : 0;

            let html = '';
            
            // Search & Filter Bar
            html += '<div class="search-filter-bar">';
            html += '<div class="search-box">';
            html += '<input type="text" id="searchInput" class="search-input" placeholder="üîç Search servers by name, IP, or OS..." onkeyup="applyFilters()">';
            html += '</div>';
            html += '<div class="filter-group">';
            html += '<span class="filter-label">Status:</span>';
            html += '<select id="statusFilter" class="filter-select" onchange="applyFilters()">';
            html += '<option value="all">All Status</option>';
            html += '<option value="main">Main Server</option>';
            html += '<option value="active">Active</option>';
            html += '<option value="warning">Warning</option>';
            html += '<option value="offline">Offline</option>';
            html += '</select>';
            html += '</div>';
            html += '<div class="filter-group">';
            html += '<span class="filter-label">Score:</span>';
            html += '<select id="scoreFilter" class="filter-select" onchange="applyFilters()">';
            html += '<option value="all">All Scores</option>';
            html += '<option value="excellent">80%+ (Excellent)</option>';
            html += '<option value="good">70-79% (Good)</option>';
            html += '<option value="warning">60-69% (Warning)</option>';
            html += '<option value="danger"><60% (Critical)</option>';
            html += '</select>';
            html += '</div>';
            html += '<button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>';
            html += '</div>';

            // Compliance Dashboard (if available)
            if (complianceDataGlobal && complianceDataGlobal.compliance_score) {
                html += '<div style="margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; font-weight: 700; color: #f8fafc; margin-bottom: 20px;">üìã Compliance Frameworks</h2>';
                html += '<div class="compliance-grid">';
                
                const frameworks = [
                    { key: 'cis_level1', name: 'CIS Level 1', icon: 'üîí' },
                    { key: 'cis_level2', name: 'CIS Level 2', icon: 'üîê' },
                    { key: 'iso27001', name: 'ISO 27001', icon: 'üåê' },
                    { key: 'nist', name: 'NIST', icon: 'üèõÔ∏è' },
                    { key: 'pcidss', name: 'PCI DSS', icon: 'üí≥' },
                    { key: 'soc2', name: 'SOC 2', icon: '‚úì' },
                    { key: 'hipaa', name: 'HIPAA', icon: 'üè•' },
                    { key: 'gdpr', name: 'GDPR', icon: 'üá™üá∫' }
                ];

                frameworks.forEach(framework => {
                    const data = complianceDataGlobal.compliance_score[framework.key];
                    if (data) {
                        const score = Math.round(data.score || 0);
                        let scoreColor = '#ef4444';
                        if (score >= 80) scoreColor = '#10b981';
                        else if (score >= 70) scoreColor = '#3b82f6';
                        else if (score >= 60) scoreColor = '#f59e0b';

                        html += `
                        <div class="compliance-card">
                            <div class="compliance-framework">${framework.icon} ${framework.name}</div>
                            <div class="compliance-score" style="color: ${scoreColor};">${score}%</div>
                            <div class="compliance-label">${data.passed || 0}/${data.total || 0} Controls</div>
                        </div>
                        `;
                    }
                });

                html += '</div>';
                html += '</div>';
            }
            
            // Stats
            html += '<div class="stats-grid">';
            html += `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Infrastructure</div>
                        <div class="stat-icon">üñ•Ô∏è</div>
                    </div>
                    <div class="stat-value">${totalServers}</div>
                    <div class="stat-label">Monitored Servers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Security Score</div>
                        <div class="stat-icon">üìä</div>
                    </div>
                    <div class="stat-value">${avgScore}%</div>
                    <div class="stat-label">Average Hardening Index</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Active Systems</div>
                        <div class="stat-icon">‚úÖ</div>
                    </div>
                    <div class="stat-value">${activeCount}</div>
                    <div class="stat-label">Online Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Warnings</div>
                        <div class="stat-icon">‚ö†Ô∏è</div>
                    </div>
                    <div class="stat-value">${totalWarnings}</div>
                    <div class="stat-label">Issues Detected</div>
                </div>
            `;
            html += '</div>';

            // Section header
            html += '<div class="section-header">';
            html += '<div class="section-title"><span>üñ•Ô∏è</span><span>All Servers</span></div>';
            html += `<div class="server-count">${totalServers} Total</div>`;
            html += '</div>';

            // Servers
            html += '<div class="servers-grid">';
            
            allServers.forEach(server => {
                const score = parseInt(server.metrics.hardening_index) || 0;
                const warnings = parseInt(server.metrics.warnings) || 0;
                const tests = parseInt(server.metrics.tests_performed) || 0;
                const suggestions = parseInt(server.metrics.suggestions) || 0;
                
                let statusClass = 'status-offline';
                let statusText = server.status || 'Unknown';
                
                if (server.is_local) {
                    statusClass = 'status-main';
                    statusText = 'MAIN';
                } else if (server.status === 'active') {
                    statusClass = 'status-online';
                    statusText = 'ONLINE';
                } else if (server.status === 'warning') {
                    statusClass = 'status-warning';
                    statusText = 'WARNING';
                } else {
                    statusText = 'OFFLINE';
                }
                
                let scoreClass = 'score-danger';
                if (score >= 80) scoreClass = 'score-excellent';
                else if (score >= 70) scoreClass = 'score-good';
                else if (score >= 60) scoreClass = 'score-warning';

                const cardClass = server.is_local ? 'server-card main-server' : 'server-card';
                
                html += `
                <div class="${cardClass}" onclick="viewServer('${server.id}')">
                    <div class="server-header">
                        <div class="server-info">
                            <h3>${server.hostname || 'Unknown'}</h3>
                            <p class="server-ip">${server.ip_address || 'N/A'}</p>
                        </div>
                        <div class="status-badge ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-box">
                            <div class="metric-value ${scoreClass}">${score}%</div>
                            <div class="metric-label">Security</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" style="color: #3b82f6;">${tests}</div>
                            <div class="metric-label">Tests</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value score-warning">${warnings}</div>
                            <div class="metric-label">Warnings</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" style="color: #8b5cf6;">${suggestions}</div>
                            <div class="metric-label">Suggestions</div>
                        </div>
                    </div>
                    
                    <div class="details-row">
                        <span class="detail-label">Operating System</span>
                        <span class="detail-value">${server.os || 'Unknown'} ${server.arch || ''}</span>
                    </div>
                `;

                if (server.is_local) {
                    html += `
                    <div class="details-row">
                        <span class="detail-label">Lynis Version</span>
                        <span class="detail-value">${server.lynis_version || 'N/A'}</span>
                    </div>
                    <div class="details-row">
                        <span class="detail-label">Last Scan</span>
                        <span class="detail-value">${server.last_scan || 'Never'}</span>
                    </div>
                    <div class="details-row">
                        <span class="detail-label">Data Source</span>
                        <span class="detail-value" style="font-family: monospace; font-size: 0.75rem;">/var/log/lynis-report.dat</span>
                    </div>
                    `;
                } else {
                    const lastSeen = timeSince(new Date(server.last_heartbeat));
                    html += `
                    <div class="details-row">
                        <span class="detail-label">Last Seen</span>
                        <span class="detail-value">${lastSeen}</span>
                    </div>
                    `;
                }

                html += '</div>';
            });

            html += '</div>';

            content.innerHTML = html;
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        async function viewServer(id) {
            console.log('Viewing server:', id);
            
            if (id === 'local') {
                // Show detailed local system view
                await showLocalSystemDetails();
                } else {
                // Show remote server details
                alert('Remote server details - Coming soon!\nServer ID: ' + id);
            }
        }

        async function showLocalSystemDetails() {
            try {
                // Fetch complete Lynis data
                const fullResponse = await fetch('/api/analysis?full=true');
                if (!fullResponse.ok) {
                    alert('Failed to load system details');
                    return;
                }
                
                const completeData = await fullResponse.json();
                
                // Also get basic summary
                const basicResponse = await fetch('/api/analysis');
                const basicData = await basicResponse.json();
                
                showCompleteDetailedView(basicData, completeData);
            } catch (error) {
                console.error('Error loading details:', error);
                alert('Failed to load system details');
            }
        }

        function showCompleteDetailedView(basicData, completeData) {
            const content = document.getElementById('dashboardContent');
            const fields = completeData.fields || {};
            
            const score = parseInt(basicData.hardening_index) || 0;
            let scoreClass = 'score-danger';
            if (score >= 80) scoreClass = 'score-excellent';
            else if (score >= 70) scoreClass = 'score-good';
            else if (score >= 60) scoreClass = 'score-warning';

            let html = '';
            
            // Back button
            html += '<div style="margin-bottom: 20px;">';
            html += '<button class="btn btn-secondary" onclick="loadDashboard()">‚Üê Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div style="background: #1e293b; border: 2px solid #3b82f6; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
            html += '<div>';
            html += '<h1 style="font-size: 2rem; color: #f8fafc; margin-bottom: 10px;">üõ°Ô∏è Complete Lynis Report</h1>';
            html += '<p style="color: #94a3b8;">All Data from ' + (fields.hostname || 'Main Server') + '</p>';
            html += '</div>';
            html += '<div class="status-badge status-main">LOCAL SYSTEM</div>';
            html += '</div>';
            html += '</div>';

            // Key Metrics
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            
            html += `<div style="background: #1e293b; border-radius: 12px; padding: 25px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Security Score</div>
                <div style="font-size: 2.5rem; font-weight: 700; color: ${scoreClass === 'score-excellent' ? '#10b981' : scoreClass === 'score-good' ? '#3b82f6' : scoreClass === 'score-warning' ? '#f59e0b' : '#ef4444'};">${score}%</div>
            </div>`;
            
            html += `<div style="background: #1e293b; border-radius: 12px; padding: 25px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Warnings</div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #ef4444;">${completeData.warnings ? completeData.warnings.length : 0}</div>
            </div>`;
            
            html += `<div style="background: #1e293b; border-radius: 12px; padding: 25px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Suggestions</div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #f59e0b;">${completeData.suggestions ? completeData.suggestions.length : 0}</div>
            </div>`;
            
            html += `<div style="background: #1e293b; border-radius: 12px; padding: 25px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Tests Performed</div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #3b82f6;">${completeData.tests ? completeData.tests.length : 0}</div>
            </div>`;
            
            html += '</div>';

            // System Information
            html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 25px;">üíª System Information</h2>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            const sysInfo = [
                ['Hostname', fields.hostname],
                ['Domain', fields.domainname],
                ['OS', fields.os_fullname],
                ['OS Version', fields.os_version],
                ['Kernel Version', fields.os_kernel_version],
                ['Boot Loader', fields.boot_loader],
                ['Service Manager', fields.service_manager],
                ['Lynis Version', fields.lynis_version],
                ['Scan Date', fields.report_datetime_start],
                ['Uptime (days)', fields.uptime_in_days],
                ['Host ID', fields.hostid]
            ];
            
            sysInfo.forEach(([label, value]) => {
                if (value) {
                    html += `<div style="border-bottom: 1px solid #334155; padding-bottom: 15px;">
                        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px;">${label}</div>
                        <div style="color: #f8fafc; font-weight: 500;">${value}</div>
                    </div>`;
                }
            });
            
            html += '</div></div>';

            // Network Information
            html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 25px;">üåê Network Configuration</h2>';
            
            if (completeData.network_interfaces && completeData.network_interfaces.length > 0) {
                html += '<div style="margin-bottom: 25px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">Network Interfaces</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.network_interfaces.forEach(iface => {
                    html += `<span style="background: #334155; color: #f8fafc; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem;">${iface}</span>`;
                });
                html += '</div></div>';
            }
            
            if (completeData.network_ipv4 && completeData.network_ipv4.length > 0) {
                html += '<div style="margin-bottom: 25px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">IPv4 Addresses</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.network_ipv4.forEach(ip => {
                    html += `<span style="background: #334155; color: #10b981; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">${ip}</span>`;
                });
                html += '</div></div>';
            }
            
            if (completeData.network_ipv6 && completeData.network_ipv6.length > 0) {
                html += '<div style="margin-bottom: 25px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">IPv6 Addresses</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.network_ipv6.forEach(ip => {
                    html += `<span style="background: #334155; color: #3b82f6; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-size: 0.85rem;">${ip}</span>`;
                });
                html += '</div></div>';
            }
            
            if (completeData.nameservers && completeData.nameservers.length > 0) {
                html += '<div style="margin-bottom: 25px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">DNS Nameservers</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.nameservers.forEach(ns => {
                    html += `<span style="background: #334155; color: #a78bfa; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">${ns}</span>`;
                });
                html += '</div></div>';
            }
            
            if (completeData.default_gateways && completeData.default_gateways.length > 0) {
                html += '<div style="margin-bottom: 25px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">Default Gateways</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.default_gateways.forEach(gw => {
                    html += `<span style="background: #334155; color: #fbbf24; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-size: 0.9rem;">${gw}</span>`;
                });
                html += '</div></div>';
            }
            
            html += '</div>';

            // Listening Ports
            if (completeData.network_listen_ports && completeData.network_listen_ports.length > 0) {
                html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 20px;">üì° Listening Ports (' + completeData.network_listen_ports.length + ')</h2>';
                html += '<div style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #e2e8f0;">';
                completeData.network_listen_ports.forEach(port => {
                    html += `<div style="padding: 8px; border-bottom: 1px solid #334155;">${port}</div>`;
                });
                html += '</div></div>';
            }

            // Software & Packages
            html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 25px;">üì¶ Software & Packages</h2>';
            
            if (completeData.package_managers && completeData.package_managers.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">Package Managers</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.package_managers.forEach(pm => {
                    html += `<span style="background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600;">${pm}</span>`;
                });
                html += '</div></div>';
            }
            
            if (fields.binaries_count) {
                html += `<div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 10px;">Binaries</h3>
                    <p style="color: #94a3b8;">Total: <span style="color: #f8fafc; font-weight: 600;">${fields.binaries_count}</span> binaries detected</p>
                </div>`;
            }
            
            if (fields.apache_version) {
                html += `<div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 10px;">Apache Web Server</h3>
                    <p style="color: #94a3b8;">Version: <span style="color: #f8fafc; font-weight: 600;">${fields.apache_version}</span></p>
                </div>`;
            }
            
            if (completeData.apache_modules && completeData.apache_modules.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h3 style="font-size: 1.1rem; color: #e2e8f0; margin-bottom: 15px;">Apache Modules (' + completeData.apache_modules.length + ')</h3>';
                html += '<details style="cursor: pointer;"><summary style="color: #3b82f6; font-weight: 600; padding: 10px 0;">Show all modules</summary>';
                html += '<div style="max-height: 300px; overflow-y: auto; margin-top: 10px; font-family: monospace; font-size: 0.8rem; color: #94a3b8;">';
                completeData.apache_modules.forEach(mod => {
                    html += `<div style="padding: 4px;">${mod}</div>`;
                });
                html += '</div></details></div>';
            }
            
            html += '</div>';

            // Security Configuration
            html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 25px;">üîí Security Configuration</h2>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            const securityConfig = [
                ['Two-Factor Auth', fields.authentication_two_factor_enabled === '1' ? '‚úÖ Enabled' : '‚ùå Disabled'],
                ['2FA Required', fields.authentication_two_factor_required === '1' ? '‚úÖ Yes' : '‚ùå No'],
                ['Failed Login Logging', fields.auth_failed_logins_logged === '1' ? '‚úÖ Enabled' : '‚ùå Disabled'],
                ['LDAP Auth', fields.ldap_auth_enabled === '1' ? '‚úÖ Enabled' : '‚ùå Disabled'],
                ['Session Timeout', fields.session_timeout_enabled === '1' ? '‚úÖ Enabled' : '‚ùå Disabled'],
                ['UEFI Secure Boot', fields.boot_uefi_booted_secure === '1' ? '‚úÖ Enabled' : '‚ùå Disabled'],
                ['SSH Daemon', fields.ssh_daemon_running === '1' ? '‚úÖ Running' : '‚≠ï Stopped'],
                ['Remote Syslog', fields.remote_syslog_configured === '1' ? '‚úÖ Configured' : '‚ùå Not Configured'],
                ['Log Rotation', fields.log_rotation_config_found === '1' ? '‚úÖ Configured' : '‚ùå Not Configured']
            ];
            
            securityConfig.forEach(([label, value]) => {
                html += `<div style="border-bottom: 1px solid #334155; padding-bottom: 15px;">
                    <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px;">${label}</div>
                    <div style="color: #f8fafc; font-weight: 500;">${value}</div>
                </div>`;
            });
            
            html += '</div></div>';

            // Available Shells
            if (completeData.available_shells && completeData.available_shells.length > 0) {
                html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 20px;">üêö Available Shells</h2>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                completeData.available_shells.forEach(shell => {
                    html += `<span style="background: #334155; color: #fbbf24; padding: 8px 16px; border-radius: 6px; font-family: monospace;">${shell}</span>`;
                });
                html += '</div></div>';
            }

            // Warnings
            if (completeData.warnings && completeData.warnings.length > 0) {
                html += '<div style="background: #7f1d1d; border: 2px solid #ef4444; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; color: #fecaca; margin-bottom: 20px;">‚ö†Ô∏è Warnings (' + completeData.warnings.length + ')</h2>';
                completeData.warnings.forEach((warning, idx) => {
                    html += `<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #fecaca; font-weight: 600; margin-bottom: 8px;">${idx + 1}. Warning</div>
                        <div style="color: #f8fafc; font-family: monospace; font-size: 0.9rem;">${warning}</div>
                    </div>`;
                });
                html += '</div>';
            }

            // Suggestions
            if (completeData.suggestions && completeData.suggestions.length > 0) {
                html += '<div style="background: #1e293b; border: 2px solid #f59e0b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; color: #fbbf24; margin-bottom: 20px;">üí° Suggestions (' + completeData.suggestions.length + ')</h2>';
                completeData.suggestions.forEach((suggestion, idx) => {
                    const parts = suggestion.split('|');
                    const testId = parts[0] || '';
                    const description = parts[1] || suggestion;
                    
                    html += `<div style="background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">${idx + 1}. ${testId}</div>
                                <div style="color: #e2e8f0; font-size: 0.95rem;">${description}</div>
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }

            // Tests Performed
            if (completeData.tests && completeData.tests.length > 0) {
                html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
                html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 20px;">üß™ Tests Performed (' + completeData.tests.length + ')</h2>';
                html += '<details style="cursor: pointer;"><summary style="color: #3b82f6; font-weight: 600; font-size: 1.1rem; padding: 10px 0;">Show all tests</summary>';
                html += '<div style="max-height: 600px; overflow-y: auto; margin-top: 15px;">';
                completeData.tests.forEach((test, idx) => {
                    html += `<div style="padding: 10px; border-bottom: 1px solid #334155; font-family: monospace; font-size: 0.85rem; color: #94a3b8;">
                        <span style="color: #3b82f6; font-weight: 600;">${idx + 1}.</span> ${test}
                    </div>`;
                });
                html += '</div></details></div>';
            }

            // Raw Data Section
            html += '<div style="background: #1e293b; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 20px;">üìÑ All Raw Fields</h2>';
            html += '<details style="cursor: pointer;"><summary style="color: #3b82f6; font-weight: 600; font-size: 1.1rem; padding: 10px 0;">Show all fields (' + Object.keys(fields).length + ' fields)</summary>';
            html += '<div style="max-height: 600px; overflow-y: auto; margin-top: 15px;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #334155;"><th style="padding: 12px; text-align: left; color: #f8fafc;">Field</th><th style="padding: 12px; text-align: left; color: #f8fafc;">Value</th></tr></thead>';
            html += '<tbody>';
            Object.entries(fields).forEach(([key, value]) => {
                html += `<tr style="border-bottom: 1px solid #334155;">
                    <td style="padding: 10px; color: #3b82f6; font-family: monospace; font-size: 0.85rem;">${key}</td>
                    <td style="padding: 10px; color: #e2e8f0; font-family: monospace; font-size: 0.85rem; word-break: break-all;">${value}</td>
                </tr>`;
            });
            html += '</tbody></table></div></details></div>';

            // Data Source
            html += '<div style="background: #334155; border-radius: 8px; padding: 20px; text-align: center;">';
            html += '<div style="color: #94a3b8; margin-bottom: 8px;">üìÅ Data Source</div>';
            html += '<div style="color: #f8fafc; font-family: monospace; font-weight: 600;">/Users/apple/lynis-report.dat</div>';
            html += '</div>';

            content.innerHTML = html;
            window.scrollTo(0, 0);
        }

        function showDetailedView(basicData, fullData) {
            const content = document.getElementById('dashboardContent');
            
            const score = parseInt(basicData.hardening_index) || 0;
            let scoreClass = 'score-danger';
            if (score >= 80) scoreClass = 'score-excellent';
            else if (score >= 70) scoreClass = 'score-good';
            else if (score >= 60) scoreClass = 'score-warning';

            let html = '';
            
            // Back button
            html += '<div style="margin-bottom: 20px;">';
            html += '<button class="btn btn-secondary" onclick="loadDashboard()">‚Üê Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div style="background: #1e293b; border: 2px solid #3b82f6; border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
            html += '<div>';
            html += '<h1 style="font-size: 2rem; color: #f8fafc; margin-bottom: 10px;">üõ°Ô∏è Main Server - Complete Analysis</h1>';
            html += '<p style="color: #94a3b8;">Detailed Lynis Security Audit Report</p>';
            html += '</div>';
            html += '<div class="status-badge status-main">LOCAL SYSTEM</div>';
            html += '</div>';
            html += '</div>';

            // Key Metrics
            html += '<div class="stats-grid" style="margin-bottom: 30px;">';
                    html += `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Hardening Index</div>
                        <div class="stat-icon">üõ°Ô∏è</div>
                            </div>
                    <div class="stat-value ${scoreClass}">${score}%</div>
                    <div class="stat-label">Security Score</div>
                            </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Tests Performed</div>
                        <div class="stat-icon">‚úì</div>
                                </div>
                    <div class="stat-value">${basicData.tests_performed || 0}</div>
                    <div class="stat-label">Security Checks</div>
                                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Warnings</div>
                        <div class="stat-icon">‚ö†Ô∏è</div>
                                </div>
                    <div class="stat-value score-warning">${basicData.warnings || 0}</div>
                    <div class="stat-label">Issues Found</div>
                            </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Suggestions</div>
                        <div class="stat-icon">üí°</div>
                                                </div>
                    <div class="stat-value">${basicData.suggestions || 0}</div>
                    <div class="stat-label">Improvements</div>
                                            </div>
                    `;
            html += '</div>';

            // System Information
            html += '<div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 25px; margin-bottom: 30px;">';
            html += '<h2 style="font-size: 1.3rem; color: #f8fafc; margin-bottom: 20px;">üìã System Information</h2>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            const sysInfo = [
                { label: 'Operating System', value: basicData.os_fullname || basicData.os_name || 'Unknown' },
                { label: 'OS Version', value: basicData.os_version || 'N/A' },
                { label: 'Lynis Version', value: basicData.lynis_version || 'N/A' },
                { label: 'Scan Date', value: basicData.scan_date || 'Never' },
                { label: 'Hostname', value: fullData.data?.hostname || 'localhost' },
                { label: 'Kernel', value: fullData.data?.linux_version || 'N/A' }
            ];

            sysInfo.forEach(info => {
                html += `
                <div style="background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155;">
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 5px;">${info.label}</div>
                    <div style="color: #e2e8f0; font-weight: 600;">${info.value}</div>
                        </div>
                    `;
            });
            
            html += '</div>';
            html += '</div>';

            // Detailed Findings
            if (fullData.data) {
                const data = fullData.data;
                
                // Security Categories
                const categories = [
                    { title: 'üîê Authentication', icon: 'üîê', items: [
                        { label: '2FA Enabled', value: data.authentication_two_factor_enabled === '1' ? 'Yes' : 'No' },
                        { label: '2FA Required', value: data.authentication_two_factor_required === '1' ? 'Yes' : 'No' },
                        { label: 'Failed Login Logging', value: data.auth_failed_logins_logged === '1' ? 'Enabled' : 'Disabled' },
                        { label: 'LDAP Auth', value: data.ldap_auth_enabled === '1' ? 'Enabled' : 'Disabled' },
                        { label: 'Session Timeout', value: data.session_timeout_enabled === '1' ? 'Enabled' : 'Disabled' }
                    ]},
                    { title: 'üåê Network', icon: 'üåê', items: [
                        { label: 'Hostname', value: data.hostname || 'Unknown' },
                        { label: 'Domain', value: data.domainname || 'None' },
                        { label: 'IPv4 Address', value: data['network_ipv4_address[]'] || 'N/A' },
                        { label: 'IPv6 Address', value: data['network_ipv6_address[]'] || 'N/A' },
                        { label: 'Network Interfaces', value: data['network_interface[]'] || 'N/A' }
                    ]},
                    { title: 'üì¶ Software', icon: 'üì¶', items: [
                        { label: 'Package Manager', value: data['package_manager[]'] || 'None' },
                        { label: 'Binaries Count', value: data.binaries_count || '0' },
                        { label: 'SUID Binaries', value: data.binaries_suid_count ? 'Found' : 'None' },
                        { label: 'Apache Version', value: data.apache_version || 'Not Installed' },
                        { label: 'Plugins Enabled', value: data.plugins_enabled === '1' ? 'Yes' : 'No' }
                    ]},
                    { title: 'üîí System Security', icon: 'üîí', items: [
                        { label: 'Kernel Version', value: data.os_kernel_version || 'N/A' },
                        { label: 'Boot Loader', value: data.boot_loader || 'Unknown' },
                        { label: 'UEFI Secure Boot', value: data.boot_uefi_booted_secure === '1' ? 'Enabled' : 'Disabled' },
                        { label: 'Service Manager', value: data.service_manager || 'Unknown' },
                        { label: 'Container', value: data.container === '1' ? 'Yes' : 'No' }
                    ]},
                    { title: 'üîê SSH & Remote', icon: 'üîê', items: [
                        { label: 'SSH Daemon', value: data.ssh_daemon_running === '1' ? 'Running' : 'Stopped' },
                        { label: 'OpenSSH Daemon', value: data.openssh_daemon_running === '1' ? 'Running' : 'Stopped' },
                        { label: 'Remote Syslog', value: data.remote_syslog_configured === '1' ? 'Configured' : 'Not Configured' }
                    ]},
                    { title: 'üìù Logging', icon: 'üìù', items: [
                        { label: 'Log Rotation', value: data.log_rotation_config_found === '1' ? 'Configured' : 'Not Configured' },
                        { label: 'Log Rotation Tool', value: data.log_rotation_tool || 'None' },
                        { label: 'Name Cache', value: data.name_cache_used === '1' ? 'Used' : 'Not Used' }
                    ]}
                ];

                categories.forEach(category => {
                    html += '<div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 25px; margin-bottom: 20px;">';
                    html += `<h2 style="font-size: 1.3rem; color: #f8fafc; margin-bottom: 20px;">${category.icon} ${category.title}</h2>`;
                    html += '<div style="display: grid; gap: 15px;">';
                    
                    category.items.forEach(item => {
                        const valueColor = item.value.toLowerCase().includes('yes') || item.value.toLowerCase().includes('active') || item.value.toLowerCase().includes('enabled') ? '#10b981' : 
                                         item.value.toLowerCase().includes('no') || item.value.toLowerCase().includes('disabled') ? '#ef4444' : '#94a3b8';
                        
                html += `
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #0f172a; border-radius: 8px; border: 1px solid #334155;">
                            <span style="color: #94a3b8;">${item.label}</span>
                            <span style="color: ${valueColor}; font-weight: 600;">${item.value}</span>
                    </div>
                `;
            });

                    html += '</div>';
                    html += '</div>';
                });
            }

            // Data File Location
            html += '<div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 25px;">';
            html += '<h2 style="font-size: 1.3rem; color: #f8fafc; margin-bottom: 15px;">üìÅ Data Source</h2>';
            html += '<div style="background: #0f172a; padding: 15px; border-radius: 8px; border: 1px solid #334155; font-family: monospace; color: #3b82f6;">';
            html += '/Users/apple/lynis-report.dat';
            html += '</div>';
            html += '</div>';

            content.innerHTML = html;
        }

        function refreshDashboard() {
            loadDashboard();
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = 
                'Last updated: ' + new Date().toLocaleTimeString();
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadDashboard, 60000);
        }

        // Modal functions
        function showAddServerModal() {
            document.getElementById('addServerModal').classList.add('active');
        }

        function closeAddServerModal() {
            document.getElementById('addServerModal').classList.remove('active');
        }

        // Copy to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#334155';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Close modal on overlay click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeAddServerModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddServerModal();
            }
        });

        // Search and Filter Functions
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const scoreFilter = document.getElementById('scoreFilter')?.value || 'all';

            let filtered = allServersGlobal.filter(server => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    server.hostname.toLowerCase().includes(searchTerm) ||
                    server.ip_address.toLowerCase().includes(searchTerm) ||
                    (server.os && server.os.toLowerCase().includes(searchTerm));

                if (!matchesSearch) return false;

                // Status filter
                if (statusFilter !== 'all' && server.status !== statusFilter) {
                    return false;
                }

                // Score filter
                if (scoreFilter !== 'all') {
                    const score = parseInt(server.metrics.hardening_index) || 0;
                    switch(scoreFilter) {
                        case 'excellent':
                            if (score < 80) return false;
                            break;
                        case 'good':
                            if (score < 70 || score >= 80) return false;
                            break;
                        case 'warning':
                            if (score < 60 || score >= 70) return false;
                            break;
                        case 'danger':
                            if (score >= 60) return false;
                            break;
                    }
                }

                return true;
            });

            renderDashboard(filtered);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('scoreFilter').value = 'all';
            renderDashboard(allServersGlobal);
        }
    </script>
</body>
</html>
